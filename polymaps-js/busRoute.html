<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Busroute from CSV</title>
    <script src="js/polymaps.min.js" type="text/javascript"></script>
    <script src="js/jquery-1.7.min.js" type="text/javascript"></script>
    <style type="text/css">
        path{
            fill: none;
            stroke-width: 1;
        }
        circle{
            fill: none;
        }
    </style>

</head>
<body id="map" style="height: 500px; width: 1000px;" >
<script type="text/javascript">
var po = org.polymaps;
// lat=13.01268&lon=80.236362&zoom=15
// 13.098159,80.16945
var map = po.map()
            .container(document.getElementById('map').appendChild(po.svg("svg")))
            .center({ lat: 13.098159, lon: 80.16945 })
            .zoom(12)
            .zoomRange([12,15])
            .add(po.interact());
map.add(po.image()
   .url(po.url("http://{S}tile.cloudmade.com"
            + "/d2126e5f6bd740079852c1ee3a900d68"
            + "/29918/256/{Z}/{X}/{Y}.png") 
        .hosts(["a.", "b.", "c.", ""])));


// Declaring prototypes to get lat and lon from the CSV
// NOTE: Change this whenever required XXX
if(!Array.prototype.lon){
    Array.prototype.lon = function (){
        return this[this.length-1]; // longtitude is the last col in csv
    }
}
if(!Array.prototype.lat){
    Array.prototype.lat = function (){
        return this[this.length-2]; // latitude is the last col in csv
    }
}
if(!Array.prototype.time){
    Array.prototype.lat = function (){
        return this[0]; // time is the first col in csv
    }
}
/*
TODO
1. Include date.js and parse time
2. Save the time values in the GeoJSON property list
3. Show coloring based on the speed - compute speed first
4. Implement a slider selector to select a time limit

*/
function createJSON(csv){
    var geo = {
        "type" : "FeatureCollection",
        "features" : []
    };
    var lines = csv.split(/\n/);
    for(var i=0; i < lines.length; i+=1){
         var thisRow = lines[i].split(/,/);
         try{
             var nextRow = lines[i+1].split(/,/);
         }catch(e){
             // console.log("last point reached");
             break;
         }
         // console.log(row.lat());
         if(i !== 0){
         var feature = {
            "geometry" : {
                "type" : "LineString",
                "coordinates" : []
            },
            "type" : "Feature",
            "properties" : {}
        };
         feature.geometry.coordinates.push([parseFloat(thisRow.lon()),parseFloat(thisRow.lat())]);
         feature.geometry.coordinates.push([parseFloat(nextRow.lon()),parseFloat(nextRow.lat())]);
         geo.features.push(feature);
         }
    }
    return geo;
}

function drawSVG(mapData, color){
    var geo = createJSON(mapData); 
    console.log(JSON.stringify(geo));
    map.add(po.geoJson()
          .features(geo.features)
          .zoom(12)
          .tile(false)
          .on("load", po.stylist()
              .attr("stroke", function(){
                    return color;
                    })
              ));
}

$.ajax({
type : "GET",
url : "busroute.csv",
dataType : "text",
success : function(data){
    drawSVG( data , "blue");
}
});


</script>

</body>
</html>
